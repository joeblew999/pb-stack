# yaml-language-server: $schema=https://taskfile.dev/schema.json

# nats.taskfile.yml

version: '3'

env:
  
vars:
  ### bin
  NATS_BIN_NAME: nats-server
  # https://github.com/nats-io/nats-server/releases/tag/v2.11.2
  NATS_BIN_VERSION: v2.11.2
  #NATS_BIN_WHICH: 
    #sh: 'which {{.NATS_BIN_NAME}}'
  #NATS_BIN_WHICH_VERSION:
    #sh: '{{.NATS_BIN_NAME}} version'
  
  # https://github.com/nats-io/nats-server/releases/download/v2.11.2/nats-server-v2.11.2-darwin-arm64.tar.gz
  # TODO: adapt to each OS.
  NATS_DEP_URL_COMPRESS_NAME: nats-server-{{.NATS_BIN_VERSION}}-darwin-arm64.tar.gz
  NATS_DEP_URL_FOLDER_NAME: nats-server-{{.NATS_BIN_VERSION}}-darwin-arm64
  NATS_DEP_URL_EXTRACT_NAME: nats-server
  NATS_DEP_URL: https://github.com/nats-io/nats-server/releases/download/{{.NATS_BIN_VERSION}}/{{.NATS_DEP_URL_COMPRESS_NAME}}

tasks:
  default:
    desc:  print
    cmds:
      - echo ''
      - echo '- bin'
      - echo 'NATS_BIN_NAME:'                   {{.NATS_BIN_NAME}}
      - echo 'NATS_BIN_VERSION:'                {{.NATS_BIN_VERSION}}
      - echo 'NATS_BIN_WHICH:'                  which {{.NATS_BIN_NAME}}
      - echo 'NATS_BIN_WHICH_VERSION:'          {{.NATS_BIN_NAME}} version
      

      - echo '- dep'
      - echo 'NATS_DEP_URL_COMPRESS_NAME:'      {{.NATS_DEP_URL_COMPRESS_NAME}}
      - echo 'NATS_DEP_URL_FOLDER_NAME:'        {{.NATS_DEP_URL_FOLDER_NAME}}
      - echo 'NATS_DEP_URL_EXTRACT_NAME:'       {{.NATS_DEP_URL_EXTRACT_NAME}}
      - echo 'NATS_DEP_URL:'                    {{.NATS_DEP_URL}}

      - 'which {{.NATS_BIN_NAME}}'
      - '{{.NATS_BIN_NAME}} version'
      - echo ''
      - echo '- vars:'
      - echo ''
    silent: true

  dep:
    cmds:
      # download and extract
      - task base:shell-wgot-tocwd -- {{.NATS_DEP_URL}}
      - task base:shell-arc-extract-tocwd -- {{.NATS_DEP_URL_COMPRESS_NAME}}
      - mv {{.BASE_SRC_PATH}}/{{.NATS_DEP_URL_FOLDER_NAME}}/{{.NATS_DEP_URL_EXTRACT_NAME}} {{.BASE_DEP_PATH}}/{{.NATS_BIN_NAME}}
      # cleanup
      - rm -f {{.BASE_SRC_PATH}}/{{.NATS_DEP_URL_COMPRESS_NAME}}
      - rm -rf {{.BASE_SRC_PATH}}/{{.NATS_DEP_URL_FOLDER_NAME}}
      - ls -al {{.BASE_DEP_PATH}}/{{.NATS_BIN_NAME}}
    silent: false
  dep:del:
    cmds:
      - rm -f {{.BASE_DEP_PATH}}/{{.NATS_BIN_NAME}}
      - ls -al {{.BASE_DEP_PATH}}/{{.NATS_BIN_NAME}}*
    silent: false



  run:
    desc: run
    cmds:
      - '{{.NATS_BIN_NAME}} -h'
    silent: false


