# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

# MUST have this ONLY in root for env variables to work.
dotenv: ['dev.env', '{{.ENV}}/.env', '{{.HOME}}/.env']


includes:
  dev: 
    taskfile: ./../../dev-taskfile.yml
    flatten: true

env:
  #KO_DOCKER_REPO: gcr.io/my-project
  KO_DOCKER_REPO: ghcr.io/joeblew999/pb-stack
  #KO_DOCKER_REPO: my-dockerhub-user

tasks:
  all:
    cmds:
      - task git:clone:src:del
      - task git:clone:src
      - task go:mod:work
      - task go:bin

### Shows break downs for granular control...

  src:
    cmds:
      - task git:clone:src
  src:del:
    cmds:
      - task git:clone:src:del

  dep:
    cmds:
    - #go install -v github.com/wailsapp/wails/v3/cmd/wails3@latest

  mod:
    cmds:
      - task go:mod:work
  dev:
    cmds:
      - task go:dev
  bin:
    cmds:
      - task go:bin
  run:
    cmds:
      # http://localhost:8000
      - task go:run

## ko : https://ko.build/configuration/
  ko:dep:
    cmds:
      - go install github.com/google/ko@latest
      - go install github.com/goreleaser/goreleaser/v2@latest
  
  ko:bin:
    desc: Build the image with ko locally
    cmds:
      - ko build --platform linux/amd64,linux/arm64 --local {{.GO_VAR_SRC_MAIN_PATH}}
      #- ko build 
  ko:run:
    desc: runs the image with ko locally
    cmds:
      - ko run {{.GO_VAR_SRC_MAIN_PATH}} --platform linux/amd64,linux/arm64
      #- ko build 


  ko:init:
    cmds:
      # no sure i need this crap..
      - touch .ko.yaml