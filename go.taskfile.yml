# yaml-language-server: $schema=https://taskfile.dev/schema.json

# go.taskfile.yml 

# Only need.
# go compiler
# garble
# go builds for native, wasm, 
# decent LDFLags structure, so we can pull Module as source and build and release using TASK structure. 


version: '3'

vars:
  ### bins 

  GO_BIN_NAME: go
  #GO_BIN_NAME: 'go{{.BASE_BINARY_EXTENSION}}'
  
  GO_BIN_WHICH:
    #sh: 'command -v {{.GO_BIN_NAME}}'
    #sh: '{{.BASE_TASK_CMD}} base:shell-which -- {{.GO_BIN_NAME}}'
  GO_BIN_VERSION:
    sh: '{{.GO_BIN_NAME}} version'

   # https://github.com/burrowers/garble
  GO_GARBLE_BIN_NAME: garble
  # https://github.com/burrowers/garble/releases/tag/v0.14.2
  GO_GARBLE_BIN_VERSION: v0.14.2
  GO_GARBLE_BIN_WHICH:
    #sh: '{{.BASE_TASK_CMD}} base:shell-which -- {{.GO_GARBLE_BIN_NAME}}'
  # TODO Issue: https://github.com/burrowers/garble/issues/941
  GO_GARBLE_BIN_WHICH_VERSION:
    #sh: '{{.GO_GARBLE_BIN_NAME}} version'

  ### envs

  GO_ENV_PATH:
    sh: '{{.GO_BIN_NAME}} env GOPATH'
  GO_ENV_BIN_PATH: '{{joinPath .GO_ENV_PATH "bin" }}'

  ### vars

  GO_VAR_SRC_PATH: '{{.BASE_SRC_PATH}}'
  GO_VAR_BIN_NAME: '{{.BASE_SRC_NAME}}'

  GO_VAR_BIN_NATIVE_PATH: '{{.BASE_BIN_PATH}}/{{.BASE_SRC_NAME}}'
  GO_VAR_BIN_WASM_PATH: '{{.BASE_BIN_PATH}}/{{.BASE_SRC_NAME}}_wasm'
  #GO_VAR_BIN_NATIVE_PATH: '{{joinPath .BASE_BIN_PATH .BASE_SRC_NAME }}'

  # Can be set at Mod or Proj level.
  #GO_VAR_BUILD_PRE: 'CGO_ENABLED=0'
  #GO_VAR_BUILD_POST: '-tags production -ldflags="-X"'


tasks:
  default:
    desc: go print
    cmds:
      - echo ''
      - echo '- bin'
      - echo 'GO_BIN_NAME:'                 {{.GO_BIN_NAME}}
      - echo 'GO_BIN_WHICH:'                {{.GO_BIN_WHICH}}
      - echo 'GO_BIN_VERSION:'              {{.GO_BIN_VERSION}}
      - echo ''
      - echo '- garble bin'
      - echo 'GO_GARBLE_BIN_NAME:'          {{.GO_GARBLE_BIN_NAME}}
      - echo 'GO_GARBLE_BIN_VERSION:'       {{.GO_GARBLE_BIN_VERSION}}
      - echo 'GO_GARBLE_BIN_WHICH:'         {{.GO_GARBLE_BIN_WHICH}}
      - echo 'GO_GARBLE_BIN_WHICH_VERSION:' {{.GO_GARBLE_BIN_WHICH_VERSION}}
      - echo ''
      - echo '- env'
      - echo 'GO_ENV_PATH:'                 {{.GO_ENV_PATH}}
      - echo 'GO_ENV_BIN_PATH:'             {{.GO_ENV_BIN_PATH}}
      - echo ''
      - echo '- var'
      - echo 'GO_VAR_SRC_PATH:'             {{.GO_VAR_SRC_PATH}}
      - echo 'GO_VAR_BIN_NAME:'             {{.GO_VAR_BIN_NAME}}
      - echo 'GO_VAR_BIN_NATIVE_PATH:'      {{.GO_VAR_BIN_NATIVE_PATH}}
      - echo 'GO_VAR_BIN_WASM_PATH:'        {{.GO_VAR_BIN_WASM_PATH}}
      - echo ''
      - echo 'GO_VAR_BUILD_PRE:'            {{.GO_VAR_BUILD_PRE}}
      - echo 'GO_VAR_BUILD_POST:'           {{.GO_VAR_BUILD_POST}}
    
      - echo ''
    silent: true
  test:
    desc: go test
    cmds:
      - echo ''
      - echo 'bin'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_BIN_NAME}} test -json > go_test_results.json
      - echo ''
    silent: false
  mod-tidy:
    desc: go mod tidy
    cmds:
      - echo ''
      - echo 'mod tidy'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_BIN_NAME}} mod tidy
      - echo ''
    silent: false
  mod-upgrade:
    desc: go mod upgrade
    cmds:
      - echo ''
      - echo 'mod upgrade ...'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_BIN_NAME}} install github.com/oligot/go-mod-upgrade@latest
      - cd {{.GO_VAR_SRC_PATH}} && go-mod-upgrade
      - echo ''
    silent: false
  install:
    desc: go install. E.G task go:install -- github.com/oligot/go-mod-upgrade@latest
    cmds:
      - echo ''
      - echo 'installing go binary to .dep'
      - '{{.GO_BIN_NAME}} install {{.CLI_ARGS}}'
      #- mv {{.GO_ENV_BIN_PATH}}/redress{{.BASE_BINARY_EXTENSION}} {{.BASE_DEP_PATH}}/{{.BASE_SHELL_REDRESS_BIN_NAME}}
      - echo ''
    silent: false

  garble:dep:
    desc: garble install
    cmds:
      - echo ''
      - echo 'garble install'
      - '{{.GO_BIN_NAME}} install mvdan.cc/garble@{{.GO_GARBLE_BIN_VERSION}}'
      - echo ''
    silent: false

  garble:help:
    desc: garble help
    cmds:
      - echo ''
      - echo 'garble'
      - '{{.BASE_TASK_CMD}} go:garble:dep'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_GARBLE_BIN_NAME}} -h
      - echo ''
    silent: false

  garble:
    desc: garble
    cmds:
      - echo ''
      - echo 'garble'
      - '{{.BASE_TASK_CMD}} go:garble:dep'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_GARBLE_BIN_NAME}} build -o {{.GO_VAR_BIN_NATIVE_PATH}}
      - echo ''
    silent: false

  inspect:
    desc: inspect the garbled binary.
    cmds:
      - echo ''
      - echo 'garble'
      - '{{.BASE_TASK_CMD}} base:shell-redress -- {{.GO_VAR_BIN_NATIVE_PATH}}'
      - echo ''
    silent: false

  gen:
    desc: go generate
    cmds:
      - echo ''
      - echo 'gen'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_BIN_NAME}} generate ./...
      - echo ''
    silent: false

  bin:
    desc: build binary
    cmds:
      #- task base:dep
      - echo ''
      - echo 'bin'
      #- task go:mod-tidy
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_VAR_BUILD_PRE}} {{.GO_BIN_NAME}} build {{.GO_VAR_BUILD_POST}} -o {{.GO_VAR_BIN_NATIVE_PATH}}
      - echo ''
    silent: false

  bin:wasm:
    desc: build go wasm
    cmds:
      - echo ''
      - echo 'bin'
      - cd {{.GO_VAR_SRC_PATH}} && {{.GO_BIN_NAME}} build -o {{.GO_VAR_BIN_WASM_PATH}}
      - echo ''

  run:
    desc: run
    cmds:
      - echo ''
      - echo 'run'
      # Best to not cd in...
      #- cd {{.BASE_BIN_PATH}} && ./{{.GO_VAR_BIN_NAME}}

      # Seems to be good enough, without mounting path.
      - '{{.BASE_BIN_PATH}}/{{.GO_VAR_BIN_NAME}}'
      - echo ''
    silent: false
   